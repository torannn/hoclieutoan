<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BankOnTap - Trình sửa lỗi MD</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="../assets/js/app-config.js"></script>
  <script src="../assets/js/mathjax-config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js" id="MathJax-script" async></script>
  <style>
    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height: 100vh;
      background: radial-gradient(1200px 700px at 5% 5%, #dbeafe, #eef2ff 45%, #f8fafc 80%);
      color: #0f172a;
    }
    .editor-pane {
      min-height: 420px;
      max-height: 70vh;
      resize: vertical;
    }
    .markdown-preview h1,
    .markdown-preview h2,
    .markdown-preview h3 { font-weight: 800; color: #0f172a; margin-top: 10px; margin-bottom: 8px; }
    .markdown-preview h1 { font-size: 1.25rem; }
    .markdown-preview h2 { font-size: 1.125rem; }
    .markdown-preview p { margin: 8px 0; }
    .markdown-preview ul { list-style: disc; padding-left: 20px; margin: 8px 0; }
    .markdown-preview code { background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1px 5px; }
  </style>
</head>
<body class="p-4 md:p-6">
  <main class="max-w-7xl mx-auto">
    <header class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur p-5 shadow-sm">
      <div class="flex flex-wrap items-start justify-between gap-3">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">BankOnTap - Trình sửa lỗi file MD</h1>
          <p class="mt-1 text-slate-600">Tạo 4 section + fill đáp án tự động, sau đó sửa danh sách lỗi trong các file Markdown và lưu trực tiếp.</p>
        </div>
        <div class="flex gap-2 flex-wrap">
          <a href="./index.html" class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-slate-700">Về BankOnTap</a>
          <a href="../index.html#/classes" class="px-3 py-2 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-slate-700">Trang chính</a>
        </div>
      </div>
    </header>

    <section class="mt-5 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="flex flex-wrap gap-2">
        <button id="prepareBtn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">1) Chia 4 section + fill null answers</button>
        <button id="refreshBtn" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">2) Tải danh sách file lỗi .md</button>
        <button id="saveBtn" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">3) Lưu file đang sửa</button>
      </div>
      <div id="statusBox" class="mt-3 text-sm rounded-lg border border-slate-200 bg-slate-50 p-3 text-slate-700">
        Sẵn sàng.
      </div>
    </section>

    <section class="mt-5 grid grid-cols-1 xl:grid-cols-3 gap-4">
      <aside class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <h2 class="font-bold text-slate-900">File lỗi Markdown</h2>
        <p class="text-xs text-slate-500 mt-1">Các file trong thư mục <code>BankOnTap/errors</code>.</p>
        <div id="mdFileList" class="mt-3 space-y-2"></div>
      </aside>

      <div class="xl:col-span-2 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="flex items-center justify-between">
            <h2 class="font-bold text-slate-900">Chỉnh sửa</h2>
            <span id="currentFile" class="text-xs text-slate-500">Chưa chọn file</span>
          </div>
          <textarea id="editor" class="editor-pane mt-3 w-full rounded-xl border border-slate-300 p-3 font-mono text-sm" spellcheck="false"></textarea>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <h2 class="font-bold text-slate-900">Preview (MathJax)</h2>
          <div id="preview" class="markdown-preview mt-3 min-h-[420px] rounded-xl border border-slate-200 bg-slate-50 p-3 overflow-auto"></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.apiBaseUrl) ? window.APP_CONFIG.apiBaseUrl : '';

    const state = {
      files: [],
      currentFile: '',
      loading: false
    };

    const els = {
      prepareBtn: document.getElementById('prepareBtn'),
      refreshBtn: document.getElementById('refreshBtn'),
      saveBtn: document.getElementById('saveBtn'),
      statusBox: document.getElementById('statusBox'),
      mdFileList: document.getElementById('mdFileList'),
      currentFile: document.getElementById('currentFile'),
      editor: document.getElementById('editor'),
      preview: document.getElementById('preview')
    };

    function setStatus(text, kind = 'info') {
      const cls = {
        info: 'border-slate-200 bg-slate-50 text-slate-700',
        ok: 'border-emerald-200 bg-emerald-50 text-emerald-700',
        warn: 'border-amber-200 bg-amber-50 text-amber-700',
        err: 'border-rose-200 bg-rose-50 text-rose-700'
      };
      els.statusBox.className = `mt-3 text-sm rounded-lg border p-3 ${cls[kind] || cls.info}`;
      els.statusBox.textContent = text;
    }

    function updatePreview() {
      const md = els.editor.value || '';
      els.preview.innerHTML = window.marked ? marked.parse(md) : `<pre>${md}</pre>`;
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise([els.preview]).catch(() => {});
      }
    }

    async function api(path, options = {}) {
      const res = await fetch(`${API_BASE}${path}`, {
        headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
        ...options
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.success === false) {
        throw new Error(data.error || `HTTP ${res.status}`);
      }
      return data;
    }

    function renderMdList() {
      els.mdFileList.innerHTML = '';
      if (!state.files.length) {
        els.mdFileList.innerHTML = '<div class="text-sm text-slate-500">Chưa có file lỗi.</div>';
        return;
      }

      state.files.forEach((name) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `w-full text-left px-3 py-2 rounded-lg border text-sm ${state.currentFile === name ? 'border-indigo-400 bg-indigo-50 text-indigo-700' : 'border-slate-200 hover:bg-slate-50 text-slate-700'}`;
        btn.textContent = name;
        btn.addEventListener('click', () => loadFile(name));
        els.mdFileList.appendChild(btn);
      });
    }

    async function refreshFiles() {
      const data = await api('/api/bankontap/md-files');
      state.files = Array.isArray(data.files) ? data.files : [];
      if (state.currentFile && !state.files.includes(state.currentFile)) {
        state.currentFile = '';
      }
      renderMdList();
      setStatus(`Đã tải ${state.files.length} file Markdown lỗi.`, 'ok');
    }

    async function loadFile(name) {
      const data = await api(`/api/bankontap/md-file?name=${encodeURIComponent(name)}`);
      state.currentFile = name;
      els.currentFile.textContent = name;
      els.editor.value = data.content || '';
      renderMdList();
      updatePreview();
      setStatus(`Đã mở file: ${name}`, 'ok');
    }

    async function saveCurrentFile() {
      if (!state.currentFile) {
        setStatus('Bạn cần chọn 1 file Markdown trước khi lưu.', 'warn');
        return;
      }
      await api('/api/bankontap/md-file', {
        method: 'POST',
        body: JSON.stringify({ name: state.currentFile, content: els.editor.value })
      });
      setStatus(`Đã lưu: ${state.currentFile}`, 'ok');
    }

    async function prepareData() {
      setStatus('Đang chạy chia 4 section + fill đáp án...', 'info');
      const data = await api('/api/bankontap/prepare', { method: 'POST', body: '{}' });
      const r = data.result || {};
      const sectionText = Array.isArray(r.sections)
        ? r.sections.map(s => `${s.title}: ${s.questionCount} câu`).join(' | ')
        : 'Không có';
      setStatus(
        `Xong. Tổng câu: ${r.totalQuestions || 0}. Unresolved: ${r.unresolvedCount || 0}. Diagram nghi ngờ lỗi: ${r.invalidDiagramCount || 0}. ${sectionText}`,
        (r.unresolvedCount || 0) > 0 ? 'warn' : 'ok'
      );
      await refreshFiles();
      if (state.files.length) {
        await loadFile(state.files[0]);
      }
    }

    els.prepareBtn.addEventListener('click', () => prepareData().catch(err => setStatus(err.message || 'Prepare failed', 'err')));
    els.refreshBtn.addEventListener('click', () => refreshFiles().catch(err => setStatus(err.message || 'Refresh failed', 'err')));
    els.saveBtn.addEventListener('click', () => saveCurrentFile().catch(err => setStatus(err.message || 'Save failed', 'err')));
    els.editor.addEventListener('input', updatePreview);

    refreshFiles().catch((err) => {
      setStatus(`Không tải được danh sách file lỗi: ${err.message}. Hãy chạy server API ở cổng 3001.`, 'err');
    });
  </script>
</body>
</html>
